#!/bin/bash
#******************************************************************************
#
# * File: colorscheme
#
# * Author:  Umut Sevdi
# * Created: 08/20/22
# * Description: Switch between light and dark mode
#*****************************************************************************
CFGDIR=`dirname $(which cfgload)`

GTK_THEME_DOCK_LIGHT="Adwaita"
GTK_THEME_LIGHT="Adwaita"
GTK_THEME_DARK="Adwaita"

GTK_ICON_LIGHT="Adwaita"
GTK_ICON_DARK="Adwaita"

PLASMA_COLOR_LIGHT="BreezeLight"
PLASMA_COLOR_DARK="BreezeDark"
QT_ICON_LIGHT="Haiku"
QT_ICON_DARK="Haiku"

PLASMA_DESKTOP_LIGHT="breeze"
PLASMA_DESKTOP_DARK="breeze"

clr=`/usr/bin/gsettings get org.gnome.desktop.interface color-scheme`
[ "$clr" = "'prefer-light'" ] && is_dark=false || is_dark=true
echo "gtk_theme_dock_light=$GTK_THEME_DOCK_LIGHT"
echo "gtk_theme=${GTK_THEME_LIGHT}|${GTK_THEME_DARK}"
echo "gtk_icon=${GTK_ICON_LIGHT}|${GTK_ICON_DARK}"
echo "plasma_color=${PLASMA_COLOR_LIGHT}|${PLASMA_COLOR_DARK}"
echo "qt_icon=${QT_ICON_LIGHT}|${QT_ICON_DARK}"
echo "plasma_desktop_theme=${PLASMA_DESKTOP_LIGHT}|${PLASMA_DESKTOP_DARK}"

Help()
{
   # Display Help
   echo "colorscheme - Toggle between light and dark mode"
   echo
   echo "Syntax: [-r]"
   echo
   echo "Options:"
   echo "-h/--help          Prints this menu."
   echo "-r/--refresh       Refreshes the display."
   echo "-i                 Display icon and exit."
   echo
}

SetTerminal()
{
    if $is_dark; then
        cat ${CFGDIR}/../alacritty/base.toml ${CFGDIR}/../alacritty/dark.toml > $HOME/.config/alacritty/alacritty.toml
    else
        cat ${CFGDIR}/../alacritty/base.toml ${CFGDIR}/../alacritty/light.toml > $HOME/.config/alacritty/alacritty.toml
    fi
    # Change themes of all actively running NeoVim instances
    for i in `ls /tmp/nvim/`; do nvim --server /tmp/nvim/$i --remote-send ":lua SetColors() <CR>" > /dev/null; done
}

SetAll()
{
    if $is_dark; then
        gtk_theme=$GTK_THEME_DARK
        gtk_icon=$GTK_ICON_DARK
        gnome_prefer="prefer-dark"
    else
        gtk_theme=$GTK_THEME_LIGHT
        gtk_icon=$GTK_ICON_LIGHT
        gnome_prefer="prefer-light"
    fi
    lib_theme=$GTK_THEME_LIB
    gsettings set org.gnome.desktop.wm.preferences theme "$gtk_theme"
    gsettings set org.gnome.desktop.interface gtk-theme "$gtk_theme"
    gsettings set org.gnome.desktop.interface icon-theme "$gtk_icon"
    gsettings set org.gnome.desktop.interface color-scheme "$gnome_prefer"
}

SetKDE()
{
    if $is_dark; then
        qt_color=$PLASMA_COLOR_DARK
        gnome_prefer="prefer-dark"
        icon=$QT_ICON_DARK
        desktop_theme=$PLASMA_DESKTOP_DARK
    else
        qt_color=$PLASMA_COLOR_LIGHT
        gnome_prefer="prefer-light"
        icon=$QT_ICON_LIGHT
        desktop_theme=$PLASMA_DESKTOP_LIGHT
    fi
    plasma-apply-colorscheme $qt_color
    if [ "$PLASMA_DESKTOP_DARK" != "$PLASMA_DESKTOP_LIGHT" ]; then
        plasma-apply-desktoptheme $desktop_theme
    fi
    gsettings set org.gnome.desktop.interface color-scheme "$gnome_prefer"
}

refresh=false
for arg in $@;do
    if   [ "$arg" = "-h" ] || [ "$arg" = "--help" ]; then
        Help
        exit
    elif [ "$arg" = "-r" ] || [ "$arg" = "--refresh" ]; then 
        refresh=true
    elif [ "$arg" = "-i" ]; then
        $is_dark && echo "  " || echo "  "
        exit
    else
        echo -e "Error: Invalid arguments" 1>&2
        exit
    fi 
done

if ! $refresh; then
    $is_dark && is_dark=false || is_dark=true
fi

echo "Updating configuration for the platform $XDG_CURRENT_DESKTOP"
case $XDG_CURRENT_DESKTOP in
    KDE)
        SetKDE
        ;;
    sway);;
    *)
        SetAll
        ;;
esac
if [ "$XDG_CURRENT_DESKTOP" = "sway" ] || [ -z "$XDG_CURRENT_DESKTOP" ];then
    gsettings set org.gnome.desktop.wm.preferences button-layout 'appmenu:'
    $is_dark &&_img="night" || _img="day"
    echo "${CFGDIR}/../background/$_img"
    exec swaybg -i ${CFGDIR}/../background/${_img}.jpg &
fi
SetTerminal &
